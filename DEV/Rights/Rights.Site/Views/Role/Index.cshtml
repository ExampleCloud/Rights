@{
    Layout = null;
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <link type="image/x-icon" rel="shortcut icon" href="~/Content/images/favicon.ico" />
    @Styles.Render("~/Content/easyui/bootstrap")
    @Styles.Render("~/Content/site")
    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/easyui")
    @Scripts.Render("~/bundles/common")
    <title>角色管理</title>
</head>
<body>
    <div id="ui_role_layout" class="easyui-layout" data-options="fit:true,border:false">
        <div data-options="region:'west',split:true,title:'组织机构'" style="width: 200px; padding: 10px;">
            <div>
                <ul id="ui_role_treeOrg"></ul>
            </div>
        </div>
        <div data-options="region:'east',split:true,border:true,collapsed:true" title="角色成员" style="width: 480px;">
            <table id="ui_role_user_dg" data-options="fit:true,border:false"></table>
        </div>
        <div data-options="region:'center',border:false, title:'角色列表'">
            <table id="ui_role_dg" data-options="fit:true,border:false"></table>
        </div>
    </div>
    @if (false)
    {
        <script type="text/javascript" src="~/Scripts/jquery-1.8.2.js"></script>
    }

    <script type="text/javascript">
        $(function () {
            $('#ui_role_treeOrg').tree({
                method: 'POST',
                url: '@Url.Action("GetTreeOrgData", "Organization")',
                lines: true,
                onClick: function (node) {
                    var centerPanel = $("#ui_role_layout").layout("panel", "center");
                    centerPanel.panel("setTitle", "角色列表 - " + node.text);
                    GetRoleByOrgId(node.id);
                }
            });

            //默认加载所有角色
            GetRoleByOrgId(0);
        });

        //获取指定机构下(包括子机构)的所有角色
        function GetRoleByOrgId(orgId) {
            $.ajax({
                url: '@Url.Action("GetButtonsByUserIdAndMenuCode", "Organization")',
                type: "POST",
                dataType: "json",
                data: { "menuCode": "role", "pageName": "role" },
                timeout: 5000,
                success: function (data) {
                    if (data.success) {
                        var oldSelectRoleId;
                        var toolbar = getToolBar(data);
                        if (data.browser) {
                            $("#ui_role_dg").datagrid({
                                url: '@Url.Action("GetPagingRoles", "Role")' + "?orgId=" + orgId,
                                striped: true,
                                rownumbers: true,
                                pagination: true,
                                pageSize: 10,
                                singleSelect: true,
                                idField: 'Id',
                                sortName: 'CreatedTime',
                                sortOrder: 'desc',
                                pageList: [10, 20, 40, 60, 80, 100],
                                frozenColumns: [[
                                                //{ field: 'ck', checkbox: true },
                                                 {
                                                     width: '100',
                                                     title: '角色名称',
                                                     field: 'Name',
                                                     sortable: true,
                                                     formatter: function (value, row, index) {
                                                         return value.length > 8 ? '<span title="' + value + '">' + value + '</span>' : value;
                                                     }
                                                 },
                                                 {
                                                     width: '200',
                                                     title: '所属机构',
                                                     field: 'OrgName',
                                                     sortable: true,
                                                     formatter: function (value, row, index) {
                                                         return value.length > 8 ? '<span title="' + value + '">' + value + '</span>' : value;
                                                     }
                                                 }]],
                                columns: [[
                                           { field: 'CreatedTime', title: '创建时间', sortable: true, width: 130 },
                                           { field: 'LastUpdatedTime', title: '最后修改时间', sortable: true, width: 130 },
                                           {
                                               field: 'Description', title: '角色描述', sortable: true, width: 300,
                                               formatter: function (value, row, index) {
                                                   return value.length > 20 ? '<span title="' + value + '">' + value + '</span>' : value;
                                               }
                                           }]],
                                toolbar: toolbar.length == 0 ? null : toolbar,
                                onSelect: function (rowIndex, rowData) {//选择角色右侧展示角色成员
                                    if (oldSelectRoleId == rowData.Id) {
                                        return;
                                    }
                                    oldSelectRoleId = rowData.Id;

                                    var $ui_role_layout = $("#ui_role_layout");
                                    var eastRoleUser = $ui_role_layout.layout("panel", "east");

                                    if (eastRoleUser.panel("options").collapsed) {
                                        $ui_role_layout.layout("expand", "east");
                                    }
                                    eastRoleUser.panel("setTitle", rowData.Name + "的成员");
                                    if ($("#ui_role_user_dg").data("datagrid")) {
                                        $("#ui_role_user_dg").datagrid({
                                            url: '@Url.Action("GetPagingRoleUsers", "Role")'+ '?roleId='+ rowData.Id
                                        });
                                    }
                                    else {
                                        $("#ui_role_user_dg").datagrid({
                                            url: '@Url.Action("GetPagingRoleUsers", "Role")'+ '?roleId='+ rowData.Id,
                                            striped: true,
                                            rownumbers: true,
                                            pagination: true,
                                            pageSize: 20,
                                            singleSelect: true,
                                            idField: 'Id',
                                            sortName: 'CreatedTime',
                                            sortOrder: 'desc',
                                            pageList: [20, 40, 60, 80, 100],
                                            columns: [[
                                                  { field: 'UserId', title: '登录id', sortable: true, width: 100 },
                                                  { field: 'UserName', title: '用户名', sortable: true, width: 80 },
                                                  {
                                                      field: 'EnableFlag', title: '启用', sortable: true, width: 60, align: 'center',
                                                      formatter: function (value, row, index) {
                                                          return value ? '<img src="@Url.Content("~/Content/easyui/icon/chk_checked.gif")" alt="已启用" title="用户已启用" />' : '<img src="@Url.Content("~/Content/easyui/icon/chk_unchecked.gif")" alt="未启用" title="用户未启用" />';
                                                      }
                                                  },
                                                  {
                                                      field: 'IsChangePwd', title: '改密', sortable: true, width: 60, align: 'center',
                                                      formatter: function (value, row, index) {
                                                          return value ? '<img src="@Url.Content("~/Content/easyui/icon/chk_checked.gif")" alt="已改密" title="用户已改密" />' : '<img src="@Url.Content("~/Content/easyui/icon/chk_unchecked.gif")" alt="未改密" title="用户未改密" />';
                                                      }
                                                  },
                                                  { field: 'CreatedTime', title: '创建时间', sortable: true, width: 130 }]]
                                        });
                                    }
                                }
                            });
                        }
                        else {
                            $.show_warning("提示", "无权限，请联系管理员！");
                        }
                    } else {
                        $.show_warning("错误", data.result);
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    if (textStatus == "timeout") {
                        $.show_warning("提示", "请求超时，请刷新当前页重试！");
                    }
                    else {
                        $.show_warning("错误", textStatus + "：" + errorThrown);
                    }
                }
            })
        };

        var orgIds = "";
        function recursionGetIds(rows) {
            if (rows.children != undefined) {
                $.each(rows.children, function (i, row) {
                    orgIds += row.id + ",";
                    recursionGetIds(row);
                });
            }
        }

        //新增角色
        function role_add() {
            $("<div/>").dialog({
                id: "ui_role_add_dialog",
                href: '@Url.Action("Add", "Role")',
                title: "添加角色",
                height: 350,
                width: 460,
                modal: true,
                buttons: [{
                    id: "ui_role_add_btn",
                    text: '添 加',
                    handler: function () {
                        $("#ui_role_addform").form("submit", {
                            url: '@Url.Action("Add", "Role")',
                            onSubmit: function (param) {
                                $('#ui_role_add_btn').linkbutton('disable');
                                if ($(this).form('validate')) {
                                    //获取机构id
                                    var t = $("#comboParent").combotree('tree');
                                    var node = t.tree('getSelected');
                                    param.OrgId = node.id;
                                    return true;
                                }
                                else {
                                    $('#ui_role_add_btn').linkbutton('enable');
                                    return false;
                                }
                            },
                            success: function (data) {
                                var dataJson = eval('(' + data + ')');
                                if (dataJson.success) {
                                    $("#ui_role_add_dialog").dialog('destroy');
                                    $.show_warning("提示", dataJson.msg);
                                    $('#ui_role_dg').datagrid('reload');
                                } else {
                                    $('#ui_role_add_btn').linkbutton('enable');
                                    $.show_warning("提示", dataJson.msg);
                                }
                            }
                        });
                    }
                }],
                onLoad: function () {
                    $("#Name").focus();
                },
                onClose: function () {
                    $("#ui_role_add_dialog").dialog('destroy');
                }
            });
        };

        //修改角色
        function role_edit() {
            var rows = $('#ui_role_dg').datagrid('getChecked');
            if (rows.length<1) {
                $.show_warning("提示", "请先勾选要修改的用户或者双击某个用户!");
                return;
            }
            if (rows.length>1) {
                $.show_warning("提示", "不支持批量修改!");
                return;
            }

            $("<div/>").dialog({
                id: "ui_user_edit_dialog",
                href: '@Url.Action("Edit", "Role")',
                title: "修改用户",
                height: 350,
                width: 460,
                modal: true,
                buttons: [{
                    id: "ui_user_edit_btn",
                    text: '修 改',
                    handler: function () {
                        $("#ui_user_editform").form("submit", {
                            url: '@Url.Action("Edit", "Role")',
                            onSubmit: function (param) {
                                $('#ui_user_edit_btn').linkbutton('disable');
                                if ($(this).form('validate')) {
                                    return true;
                                }
                                else {
                                    $('#ui_user_edit_btn').linkbutton('enable');
                                    return false;
                                }
                            },
                            success: function (data) {
                                var dataJson = eval('(' + data + ')');
                                if (dataJson.success) {
                                    $("#ui_user_edit_dialog").dialog('destroy');
                                    $.show_warning("提示", dataJson.msg);
                                    $("#ui_role_dg").datagrid("reload").datagrid('clearSelections').datagrid('clearChecked');//刷新并清除已选择
                                } else {
                                    $('#ui_user_edit_btn').linkbutton('enable');
                                    $.show_warning("提示", dataJson.msg);
                                }
                            }
                        });
                    }
                }],
                onLoad: function () {
                    //初始化
                    $("#id").val(rows[0].Id);
                    $("#OriginalUserId").val(rows[0].UserId);
                    $("#NewUserId").val(rows[0].UserId);
                    $("#NewUserName").val(rows[0].UserName);
                    if (rows[0].EnableFlag) {
                        $("#EnableFlag").attr("checked", "checked");
                    }
                    if (rows[0].IsChangePwd) {
                        $("#IsChangePwd").attr("checked", "checked");
                    }
                },
                onClose: function () {
                    $("#ui_user_edit_dialog").dialog('destroy');
                }
            });
        }

        //删除角色
        function role_delete() {
            var rows = $('#ui_role_dg').datagrid('getChecked');
            if (rows.length < 1) {
                $.show_warning("提示", "请先勾选要删除的用户");
                return;
            }

            $.messager.confirm('提示', '确定删除勾选的这' + rows.length + '个用户？', function (r) {
                if (r) {
                    para = {};
                    para.action = "delete";
                    para.timespan = new Date().getTime();
                    para.ids = "";
                    $.each(rows, function (i, row) {
                        para.ids += row.Id + ",";
                    });
                    $.ajax({
                        url: '@Url.Action("Delete", "Role")',
                        data: para,
                        type: "POST",
                        dataType: "json",
                        success: function (data) {
                            if (data.success) {
                                $.show_warning("提示", data.msg);
                                $("#ui_role_dg").datagrid("reload").datagrid('clearSelections').datagrid('clearChecked');
                            } else {
                                $.show_warning("提示", data.msg);
                            }
                        }
                    });
                }
            });
        };


        //角色授权
        function role_setorg() {
            var rows = $("#ui_role_dg").datagrid("getChecked");
            if (rows.length < 1) {
                $.show_warning("提示", "请先勾选要设置机构的用户");
                return;
            }
            $("<div/>").dialog({
                id: "ui_user_setorg_dialog",
                href: '@Url.Action("SetOrg", "Role")',
                title: rows.length == 1 ? "设置机构" : "批量设置机构：" + rows.length + "个用户",
                height: 220,
                width: 380,
                modal: true,
                buttons: [{
                    id: "ui_user_setorg_btn",
                    text: '确 定',
                    handler: function () {
                        $("#ui_user_setorgform").form("submit", {
                            url: '@Url.Action("SetOrg", "Role")',
                            onSubmit: function (param) {
                                $('#ui_user_setorg_btn').linkbutton('disable');
                                param.action = 'setdep';
                            },
                            success: function (data) {
                                var dataJson = eval('(' + data + ')');
                                if (dataJson.success) {
                                    $("#ui_user_setorg_dialog").dialog('destroy');
                                    $.show_warning("提示", dataJson.msg);
                                    $("#ui_role_dg").datagrid("reload").datagrid('clearSelections').datagrid('clearChecked');
                                } else {
                                    $('#ui_user_setorg_btn').linkbutton('enable');
                                    $.show_warning("提示", dataJson.msg);
                                }
                            }
                        });
                    }
                }],
                onLoad: function () {
                    if (rows.length == 1) {//单个用户
                        $("#UserIds").val(rows[0].Id);
                        $("#UserNames").val(rows[0].UserName);
                        $("#OrgIds").combotree('setValues', stringToList(rows[0].UserOrgIds));
                    }
                    else {//多个用户(批量)
                        var userids = "";
                        var usernames = "";
                        for (var i = 0; i < rows.length; i++) {
                            userids += rows[i].Id + ",";
                            usernames += rows[i].UserName + ",";
                        }
                        $("#UserIds").val(userids.substring(0, userids.length - 1));
                        $("#UserNames").val(usernames.substring(0, usernames.length - 1));
                    }
                },
                onClose: function () {
                    $("#ui_user_setorg_dialog").dialog('destroy');
                }
            });
        };

    </script>

</body>
</html>